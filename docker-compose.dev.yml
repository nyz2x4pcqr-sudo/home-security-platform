services:
  event-bus:
    image: rabbitmq:3-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - event-bus-data:/var/lib/rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: securepass123
    networks:
      - home-security

  ingest:
    build: ./services/ingest
    volumes:
      - ./services/ingest:/app
    depends_on:
      - event-bus
    environment:
      - EVENT_BUS_URL=amqp://admin:changeme123@event-bus:5672/
      - CONFIG_PATH=/config/default.yml
    networks:
      - home-security

  recorder:
    build: ./services/recorder
    volumes:
      - ./services/recorder:/app
    depends_on:
      - event-bus
      - ingest
    environment:
      - EVENT_BUS_URL=amqp://admin:changeme123@event-bus:5672/
      - CONFIG_PATH=/config/default.yml
      - RECORDINGS_PATH=/data/recordings
    networks:
      - home-security

  motion:
    build: ./services/motion
    volumes:
      - ./services/motion:/app
    depends_on:
      - event-bus
      - recorder
    environment:
      - EVENT_BUS_URL=amqp://admin:changeme123@event-bus:5672/
      - CONFIG_PATH=/config/default.yml
    networks:
      - home-security

  api:
    build: ./services/api
    ports:
      - "8000:8000"
    volumes:
      - ./services/api:/app
    depends_on:
      - event-bus
    environment:
      - EVENT_BUS_URL=amqp://admin:changeme123@event-bus:5672/
      - CONFIG_PATH=/config/default.yml
      - DATA_PATH=/data
    networks:
      - home-security

  web-ui:
    build: ./web-ui
    ports:
      - "8080:80"
    volumes:
      - ./web-ui:/usr/share/nginx/html
      - ./web-ui/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - api
    networks:
      - home-security

volumes:
  event-bus-data:
  data:

networks:
  home-security:
    driver: bridge